# Single server; which hostnames it serves comes from $DOMAIN_HOSTS
{$DOMAIN_HOSTS} {
  {$TLS_CONFIG}

  encode gzip

  # redirect www â†’ apex only if 'www' is in the host list (i.e., prod)
  @www host www.{$DOMAIN}
  redir @www https://{$DOMAIN}{uri} 308

  # Strapi routes
  @strapi path /api* /_health /admin* /uploads* \
               /content-manager* /content-type-builder* \
               /users-permissions* /i18n* /email* /upload* \
               /graphql* /webhooks* /documentation* /marketplace*
  handle @strapi {
    reverse_proxy strapi:1337 {
      # Caddy already passes X-Forwarded-*; keep only what you truly need:
      header_up CF-Connecting-IP {http.request.header.CF-Connecting-IP}
    }
  }

  # Next.js
  handle {
    reverse_proxy frontend:3000 {
      header_up CF-Connecting-IP {http.request.header.CF-Connecting-IP}
    }
  }

  log {
    output file /data/access-{$APP_ENV}.log
    format console
  }
}
